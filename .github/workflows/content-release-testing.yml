name: ZZ Content Release Workflow testing

on:
  workflow_dispatch:
  pull_request:

  # repository_dispatch:
  #   types: [content-release]



concurrency:
  group: content-release-node-limit

env:
  CMS_NOTIFICATIONS_SLACK: CJT90C0UT # cms-notifications
  VFS_PLATFORM_BUILDS_SLACK: C0MQ281DJ # vfs-platform-builds
  BROKEN_LINKS_SLACK: C030F5WV2TF # content-broken-links
  CONTENT_BUILD_CHANNEL_ID: C02VD909V08 #status-content-build
  NODE_EXTRA_CA_CERTS: /etc/ssl/certs/VA-Internal-S2-RCA1-v1.cer.pem
  BUILDTYPE: vagovstaging
  DEPLOY_BUCKET: staging.content.www.va.gov
  DRUPAL_ADDRESS: https://main-rufdsbo6qfzad8ds1x1anvitvwgjirbu.demo.cms.va.gov
  # Not a sensitive secret; used for our testing environments only, with systems
  # with sanitized databases.
  DRUPAL_PASSWORD: drupal8
  INSTANCE_TYPE: c5d.4xlarge
  MAXIMUM_HEAP: 5000



jobs:

  validate-build-status:
    name: Test secrets retrieval
    runs-on:
      - self-hosted
    outputs:
      REF: ${{ steps.get-latest-release.outputs.target_commitish }}
      TAG: ${{ steps.get-latest-release.outputs.tag_name }}
    timeout-minutes: 15

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        if: ${{ steps.get-broken-link-info.outputs.UPLOAD_AND_NOTIFY == '1' && always() }}
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-gov-west-1

      - name: Checkout
        uses: actions/checkout@v3
        with:
          path: content-release/content-build

      - name: set Drupal prod username
        uses: department-of-veterans-affairs/action-inject-ssm-secrets@latest
        with:
          ssm_parameter: /cms/prod/drupal_api_users/content_build_api/username
          env_variable_name: DRUPAL_USERNAME

