/* eslint-disable no-param-reassign, no-continue, no-console */
const fs = require('fs');
const path = require('path');
const appRegistry = require('../../../../applications/registry.json');

/**
 * Load skeleton manifest generated by vets-website build
 * Returns object mapping entryName to skeleton HTML
 */
function loadSkeletonManifest() {
  // Path to skeleton manifest in vets-website build output
  const skeletonPath = path.join(
    __dirname,
    '../../../../../vets-website/build/localhost/generated/skeleton-manifest.json',
  );

  try {
    if (fs.existsSync(skeletonPath)) {
      const content = fs.readFileSync(skeletonPath, 'utf8');
      const manifest = JSON.parse(content);
      console.log(
        `[create-react-pages] Loaded skeleton manifest with ${
          Object.keys(manifest).length
        } entries`,
      );
      return manifest;
    }
    console.log(
      '[create-react-pages] No skeleton manifest found, using fallback loading indicators',
    );
  } catch (error) {
    console.warn(
      '[create-react-pages] Error loading skeleton manifest:',
      error.message,
    );
  }
  return {};
}

function createReactPages(files, drupalData = { data: {} }, done) {
  const {
    data: {
      alerts: alertsItem = {},
      banners,
      bannerAlerts: bannerAlertsItem = {},
      promoBanners,
    },
  } = drupalData;
  const alertItems = { alert: alertsItem };

  // Load skeleton manifest for hydration support
  const skeletonManifest = loadSkeletonManifest();

  appRegistry.forEach(
    ({
      entryName,
      appName,
      rootUrl,
      template,
      useLocalStylesAndComponents,
    }) => {
      const trimmedUrl = path.join('.', rootUrl);
      const filePath = path.join(trimmedUrl, 'index.html');
      if (!files[filePath]) {
        if (global.verbose) {
          console.log(
            `Generating HTML template for application ${appName} at ${rootUrl}`,
          );
        }
        files[filePath] = {
          title: appName,
          entryname: entryName,
          shouldAddDebugInfo: true,
          useLocalStylesAndComponents: !!useLocalStylesAndComponents,
          debug: null,
          path: trimmedUrl,
          layout: 'page-react.html',
          contents: Buffer.from('\n<!-- Generated from manifest.json -->\n'),
          entityUrl: { path: `/${trimmedUrl}` },
          alertItems,
          ...{ bannerAlert: bannerAlertsItem },
          ...{ banners },
          ...{ promoBanners },
          ...template,
          // Add skeleton HTML if available for this app
          skeletonHTML: skeletonManifest[entryName]?.html || '',
        };
      }
    },
  );

  done?.();
}

module.exports = createReactPages;
